<!-- ShareDo Blade: Ongoing Advice Management -->
<div class="modal-header">
    <div class="flex-row">
        <div class="column-auto">
            <span class="fa fa-clock-o header-icon"></span>
        </div>
        <div class="column-fit">
            <h4 class="modal-title">Ongoing Advice Management</h4>
            <div class="small">Pause or resume ongoing advice for this work item</div>
        </div>
    </div>

    <!-- Ribbon Bar -->
    <!-- ko component: { name: "ribbon", params: { ribbon: blade.ribbon }} -->
    <!-- /ko -->
</div>

<div class="Alt-AdviceManagement-AdvicePauseResumeBlade modal-body nano">
    <div class="nano-content">
        
        <!-- Loading State -->
        <div data-bind="visible: model.loading" class="text-center" style="padding: 40px;">
            <i class="fa fa-spinner fa-spin fa-3x"></i>
            <p style="margin-top: 20px;">Loading ongoing advice status...</p>
        </div>
        
        <!-- Error Message -->
        <div data-bind="visible: model.hasError" class="alert alert-danger" style="margin: 20px;">
            <i class="fa fa-exclamation-triangle"></i>
            <strong>Error:</strong> <span data-bind="text: model.errorMessage"></span>
        </div>
        
        <!-- Success Message -->
        <div data-bind="visible: model.hasSuccess" class="alert alert-success" style="margin: 20px;">
            <i class="fa fa-check"></i>
            <span data-bind="text: model.successMessage"></span>
        </div>
        
        <!-- Main Content - Only show when loaded -->
        <div data-bind="visible: model.loaded() && !model.loading()">
            
            <!-- Current Status Panel -->
            <div class="panel panel-default" style="margin-bottom: 20px;">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <i class="fa fa-info-circle"></i>
                        Current Status
                    </h3>
                </div>
                <div class="panel-body">
                    <form class="form-horizontal">
                        <!-- Status Display -->
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Status:</label>
                            <div class="col-sm-9">
                                <p class="form-control-static">
                                    <i data-bind="css: 'fa ' + model.currentStatusIcon()"></i>
                                    <strong data-bind="text: model.currentStatusText, css: model.currentStatusClass"></strong>
                                </p>
                            </div>
                        </div>
                        
                        <!-- Last Modified -->
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Last Modified:</label>
                            <div class="col-sm-9">
                                <p class="form-control-static" data-bind="text: model.lastModifiedText"></p>
                            </div>
                        </div>
                        
                        <!-- Last Reason (if exists) -->
                        <div class="form-group" data-bind="visible: model.lastReason">
                            <label class="col-sm-3 control-label">Reason:</label>
                            <div class="col-sm-9">
                                <p class="form-control-static" data-bind="text: model.lastReason"></p>
                            </div>
                        </div>
                        
                        <!-- Next Advice Date -->
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Next Advice Date:</label>
                            <div class="col-sm-9">
                                <p class="form-control-static" data-bind="text: model.formattedNextAdviceDate"></p>
                            </div>
                        </div>
                        
                        <!-- Task Management Status -->
                        <div class="form-group" data-bind="visible: model.taskManagementStatus">
                            <label class="col-sm-3 control-label">Advice Tasks:</label>
                            <div class="col-sm-9">
                                <p class="form-control-static">
                                    <i data-bind="css: model.hasAdviceTasks() ? 'fa fa-tasks text-success' : 'fa fa-tasks text-muted'"></i>
                                    <span data-bind="text: model.taskManagementStatus"></span>
                                </p>
                                <!-- ko if: model.hasAdviceTasks() -->
                                <div data-bind="foreach: model.adviceTasks" style="margin-top: 10px;">
                                    <div class="alert alert-info" style="padding: 8px 12px; margin-bottom: 5px;">
                                        <strong data-bind="text: title || 'Untitled Task'"></strong>
                                        <!-- ko if: dueDate -->
                                        <br><small><i class="fa fa-calendar"></i> Due: <span data-bind="text: new Date(dueDate).toLocaleDateString()"></span></small>
                                        <!-- /ko -->
                                        <!-- ko if: description -->
                                        <br><small data-bind="text: description"></small>
                                        <!-- /ko -->
                                    </div>
                                </div>
                                <!-- /ko -->
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Action Form Panel -->
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <i data-bind="css: 'fa ' + model.actionButtonIcon()"></i>
                        <span data-bind="text: model.actionButtonText()"></span>
                    </h3>
                </div>
                <div class="panel-body">
                    <form class="form-horizontal">
                        
                        <!-- Pause Warning -->
                        <div data-bind="visible: model.showPauseFields" class="alert alert-warning">
                            <i class="fa fa-exclamation-triangle"></i>
                            <strong>Note:</strong> Pausing ongoing advice will prevent automatic advice generation and notifications for this work item until resumed.
                            Any existing advice tasks will be removed from the diary.
                        </div>
                        
                        <!-- Resume Info -->
                        <div data-bind="visible: model.showResumeFields" class="alert alert-info">
                            <i class="fa fa-info-circle"></i>
                            <strong>Note:</strong> Resuming ongoing advice will re-enable automatic advice generation and notifications for this work item.
                            If you specify a next advice date, an advice task will be created with that due date.
                        </div>
                        
                        <!-- Reason Input -->
                        <div class="form-group">
                            <label class="col-sm-3 control-label">
                                Reason:
                                <span class="text-muted">(optional)</span>
                            </label>
                            <div class="col-sm-9">
                                <textarea class="form-control" 
                                        rows="3"
                                        placeholder="Enter reason for this action..."
                                        data-bind="value: model.reasonInput, enable: model.canPerformAction"
                                        maxlength="500"></textarea>
                                <span class="help-block">
                                    <span data-bind="text: (model.reasonInput() || '').length"></span> / 500 characters
                                </span>
                            </div>
                        </div>
                        
                        <!-- Next Advice Date (when resuming) -->
                        <div data-bind="visible: model.showResumeFields" class="form-group">
                            <label class="col-sm-3 control-label">
                                Next Advice Date:
                                <span class="text-muted">(optional)</span>
                            </label>
                            <div class="col-sm-9">
                                <input type="date" 
                                       class="form-control"
                                       data-bind="value: model.nextAdviceDateInput, enable: model.canPerformAction">
                                <span class="help-block text-danger" data-bind="visible: !model.nextAdviceDateValid()">
                                    Please enter a valid future date.
                                </span>
                                <span class="help-block" data-bind="visible: model.nextAdviceDateValid()">
                                    When should the next ongoing advice review occur?
                                </span>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="form-group">
                            <div class="col-sm-offset-3 col-sm-9">
                                <button type="button" 
                                        data-bind="css: 'btn ' + model.actionButtonClass(), 
                                                 click: toggleOngoingAdvice, 
                                                 enable: model.canPerformAction() && !model.saving()">
                                    <i data-bind="css: model.saving() ? 'fa fa-spinner fa-spin' : 'fa ' + model.actionButtonIcon()"></i>
                                    <span data-bind="text: model.saving() ? 'Processing...' : model.actionButtonText()"></span>
                                </button>
                                
                                <button type="button" 
                                        class="btn btn-default"
                                        data-bind="click: clearForm, enable: !model.saving()">
                                    <i class="fa fa-eraser"></i> Clear Form
                                </button>
                            </div>
                        </div>
                        
                        <!-- Validation Summary -->
                        <div data-bind="visible: !model.canPerformAction() && model.loaded()" class="form-group">
                            <div class="col-sm-offset-3 col-sm-9">
                                <div class="alert alert-warning">
                                    <strong><i class="fa fa-exclamation-triangle"></i> Action cannot be performed:</strong>
                                    <ul class="list-unstyled" style="margin-top: 10px;">
                                        <li data-bind="visible: !model.nextAdviceDateValid() && model.showResumeFields()">
                                            • Please enter a valid future date for next advice
                                        </li>
                                        <li data-bind="visible: !model.reasonValid()">
                                            • Reason cannot exceed 500 characters
                                        </li>
                                        <li data-bind="visible: !model.workItemId()">
                                            • No work item selected
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                    </form>
                </div>
            </div>
            
            <!-- Debug Info Panel (Development Only) -->
            <!-- ko if: window.location.href.indexOf('debug=true') > -1 -->
            <div class="panel panel-info" style="margin-top: 20px;">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <i class="fa fa-bug"></i>
                        Debug Information
                    </h3>
                </div>
                <div class="panel-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Work Item ID:</label>
                            <div class="col-sm-9">
                                <p class="form-control-static" data-bind="text: model.workItemId"></p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Work Type ID:</label>
                            <div class="col-sm-9">
                                <p class="form-control-static" data-bind="text: model.workTypeId"></p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Enabled:</label>
                            <div class="col-sm-9">
                                <p class="form-control-static" data-bind="text: model.enabled"></p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Current User:</label>
                            <div class="col-sm-9">
                                <p class="form-control-static" data-bind="text: model.currentUser() ? model.currentUser().name : 'Unknown'"></p>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <!-- /ko -->
            
        </div>
        
    </div>
</div>